const express = require('express');
const router = express.Router();
const passport = require('passport');
const User = require('../models/user');
const Article = require('../models/article');

const { isLogin } = require('../config/auth');
const { routeController } = require('../config/ac');

const user = require('./user');
const admin = require('./admin');
const general = require('./general');

/*////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
----------------------------------------login Post-------------------------------------------------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/

router.post('/login', (req, res, next) => {
    passport.authenticate('local', {
        successRedirect: '/api/allArticle/1',
        failureRedirect: '/api/allArticle/1',
        failureFlash: true
    })(req, res, next);
});

router.get('/logOut', (req, res, next) => {
    let name = req.user.firstName + " " + req.user.lastName;
    req.logout();
    req.flash('success_msg', `${name} ، خدانگهدار...`)
    res.redirect('./allArticle/1');

});


/*////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
----------------------------------------Register Post-------------------------------------------------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/

router.post('/register', (req, res, next) => {
    const { firstName, lastName, userName, password, gender, phone } = req.body;
    console.log(req.body);

    User.findOne({ userName })
        .then((user) => {
            if (user) {
                return res.json({ success: false, msg: "user is exist!" })
            }

            new User({ firstName, lastName, userName, password, gender, phone, role: "user" })
                .save()
                .then((user) => res.json({ success: true, msg: "User Adedd...", user }))
                .catch((err) => res.json({ success: false, msg: "User Not Adedd ", err }));
        })
        .catch((err) => console.log(err))

});

/*////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
----------------------------------------Router Access Controler-------------------------------------------------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/

router.get('/allArticle/:page', (req, res, next) => {

    let page = 5 * (--req.params.page)

    Article.find({}, async (err, article) => {

        for (let i = 0; i < article.length; i++) {

            article[i].text = article[i].text.slice(0, 250) + " ...";
            await User.findOne({ userName: article[i].userName }, { firstName: 1, lastName: 1, _id: 0 }, (err, user) => {

                if (err) res.json({ success: false, err })
                article[i].firstName = user.firstName;
                article[i].lastName = user.lastName;

            })
        }
        res.render('index', {
            article,
            title: 'مقالستان'
        }
        )
    })
        .sort({ dateCreate: -1 })
        .limit(5)
        .skip(page);
});



/*////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
----------------------------------------Router Access Controler-------------------------------------------------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/

router.use('/admin', isLogin, routeController('admin'), admin);
router.use('/user', isLogin, routeController('user'), user);
router.use('/general', isLogin, general);


module.exports = router;
